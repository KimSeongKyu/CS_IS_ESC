# Load Balancing이란?
>_부하분산_ 이라고 불리기도 하는 Load Balancing은 컴퓨터 네트워크 기술의 일종으로 중앙처리장치 혹은 저장장치와 같은 컴퓨터 자원들에게 작업을 나누는 것을 의미한다.

#### Reference
- [로드밸런서(Load Balancer)의 개념과 특징](https://post.naver.com/viewer/postView.nhn?volumeNo=27046347&memberNo=2521903)
- [네트워크의 부하분산, 로드밸런싱 그리고 로드밸런서](https://www.stevenjlee.net/2020/06/30/%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC%EC%9D%98-%EB%B6%80%ED%95%98%EB%B6%84%EC%82%B0-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1-load-balancing-%EA%B7%B8/)
- [[10분 테코톡]🐿 제이미의 Forward Proxy, Reverse Proxy, Load Balancer](https://youtu.be/YxwYhenZ3BE)
- [대용량 세션을 위한 로드밸런서](https://d2.naver.com/helloworld/605418)

---

## 더 자세히 Load Balancing 이란?
- 서버에 가해지는 `부하(=로드)`를 `분산(=밸런싱)`해주는 장치 또는 기술이다.
- 클라이언트와 서버풀(분산 네트워크를 구성하는 서버들의 그룹) 사이에 위치하며, 한 대의 서버로 부하가 집중되지 않도록 `트래픽`을 `분산처리`해 각각의 서버가 최적의 퍼포먼스를 보일 수 있도록 한다.

---

## Load Balancing이 필요한 이유
- 사업의 규모가 확장되고, 클라이언트의 수가 늘어나게 되면 기존 서버만으로는 정상적인 서비스가 불가능하다
- 이 경우, 증가한 트래픽에 대처할 수 있는 방법은 크게 두 가지다.
    1. __Scale-Up__ : 서버 자체의 성능을 높이는 것
    2. __Scale-Out__ : 여러 대의 서버를 두는 것
        - __Scale-Out__ 방식은 여러 대의 서버로 트래픽을 균등하게 분산해주는 `로드밸런싱`이 반드시 필요하다.

---
## 로드 밸런서의 기본 동작 방식
1. 클라이언트의 브라우저에 naver.com 이라고 입력
2. 클라이언트에 설정된 메인 DNS 서버로 naver.com의 IP 주소를 문의
3. 메인 DNS 서버는 naver.com 주소를 관리하는 별도의 DNS 서버에 IP 주소를 문의
4. 별도 관리 DNS 서버는 로드밸런서의 IP(Virtual IP, L4스위치를 동작시키는 서버의 IP주소)주소를 메인 DNS 서버에게 알려줌.
5. 메인 DNS 서버는 획득한 Virtual IP주소를 클라이언트에 전송
6. 클라이언트에서 로드밸런서의 Virtual IP주소로 HTTP 요청
7. 로드 밸런서는 별도 로드밸런싱 알고리즘을 통하여 서버에게 요청을 전송
8. 서버의 작업 결과를 받은 로드밸런서는 전달받은 HTTP 결과를 클라이언트에게 전송


---

## L4 로드 밸런싱
- [복습] L4 계층은 IP에 의해 전달되는 패킷의 오류를 검사하고 재전송 요구 등의 제어를 담당하는 계층이다.
- L4 로드밸런서는 L4 게층에서 동작하는 로드밸런서 이므로 네트워크 계층의 정보(OP)나 전송 계층의 정보(TCP,UDP)를 바탕으로 로드를 분산한다.
- 즉, IP 주소나, 포트 번호, MAC주소, 전송 프로토콜(TCP/UDP) 등에 따라 트래픽을 나누고 분산처리하는 것이 가능하다.
- 위와 같은 이유로 L4의 로드밸런서를 CLB(Commection Load Balancer) 또는 SLB(Session Load Balancer)라고 부르기도 한다.
- 데이터 안을 보지 않고 패킷 레벨에서만 로드를 분산하기 때문에 속도가 빠르고 효율이 높다.
- 섬세한 라우팅이 불가능하지만 L7로드 밸런서보다 저렴하다.

---

## L4 로드 밸런싱 알고리즘
- __라운드 로빈__
    - 서버에 들어온 요청을 순서대로 돌아가며 배정하는 방식.
    - 클라이언트의 요청을 순서대로 분배하기 때문에 여러 대의 서버가 동일한 스펙을 갖고 있고, 서버와의 연결(세션)이 오래 지속되지 않는 경우에 활용하기 적합하다.

- __가중 라운드로빈 방식__
    - 각 서버에 가중치를 매기고 가중치가 높은 서버에 요청을 우선적으로 배정하는 방식.
    - 주로 서버의 트래픽 처리 능력이 상이한 경우 사용된다.
    - 예를 들어 A라는 서버가 5라는 가중치를 갖고 B라는 서버가 2라는 가중치를 갖는다면, 로드밸런서는 라운드로빈 방식으로 A 서버에 5개 B 서버에 2개의 요청을 전달한다.

- __IP 해시 방식__
    - 클라이언트의 IP주소를 특정 서버로 매핑하여 요청을 처리하는 방식.
    - 사용자의 IP를 해싱해서 로드를 분배하기 때문에 사용자가 항상 동일한 서버로 연결되는 것을 보장한다. 

- __최소 연결 방식__
    - 요청이 들어온 시점에 가장 적은 연결 상태를 보이는 서버에 트래픽을 배정하는 방식.
    - 자주 세션이 길어지거나, 서버에 분배된 트래픽들이 일정하지 않은 경우에 적합하다.


- __최소 리스폰타임(Least Response Time Method)__
    - 서버의 현재 연결 상태와 응답시간을 모두 고려하여 트래픽을 배분한다. 
    - 가장 적은 연결 상태와 가장 짧은 응답시간을 보이는 서버에 우선적으로 로드를 배분하는 방식이다.


---
## L7 로드 밸런싱
- L4 로드밸런서의 기능을 포함하는 것 뿐만 아니라 7계층의 프로토콜(HTTP,SMTP,FTP)의 정보를 바탕으로 로드를 분산처리 하는 것이 가능하다.
- 다시말해 HTTP 헤더, 쿠키 등과 같은 사용자 요청을 기준으로 특정 서버에 트래픽을 분산하는 것이 가능하다. 
- 정리하자면 패킷 내용을 확인하고 그 내용에 따라 로드를 특정 서버에 분배하는 것이 가능한 것이다.
- 특정 기능을 하는 요청이 들어오면 그 요청을 처리하는 서버로 보내는 더 섬세한 라우팅이 가능하고, 비정상적인 트래픽을 필터링 할 수 있다.
-다만, 패킷의 내용을 복호화 해야하기 때문에 더 많은 비용이 든다.
---
## L7로드밸런싱 방법
- __URL 스위칭 방식__
    - 특정 하위 URL들은 특정 서버로 처리하는 방식이다.
    - `.../mulgyeol/image` 또는 `../mulgyeol/video`와 같은 특정 URL을 가진 주소들은 서버가 아닌 별도의 저장공간에 있는 객체 데이터로 바로 연결되도록 구성할 수 있다.
- __Context 스위칭 방식__
    - 클라이언트가 요청한 특정 리소스에 대해 특정 서버 등으로 연결을 해줄 수 있다.
    - 예를 들어, 이미지 파일의 경우 확장자를 참조하여 별도로 구성된 이미지 파일이 있는 서버/저장공간으로 직접 연결해 줄 수 있다.
- __쿠키 지속성(Persistence with Cookies)__ 
    - 쿠키 정보를 바탕으로 클라이언트가 연결했던, 동일한 서버에 계속 할당해 줄 수 있다.
    - 특히 사설 네트워크에 있던 클라이언트의 IP주소가 공인 IP주소로 치환되어 전송하는 방식을 지원한다.(헤더에 클라이언트 IP주소를 별도로 기록한다.)

---
## L4와 L7 로드밸런서의 비교
<p align="center"><img src="./img/LoadBalancing/L4_L7.png"></p><br>

---
## L4/L7 로드밸런서의 주요 성능 지표
1. __초당 연결 수__
    - 최대 처리가 가능한 초당 TCP 세션의 개수를 의미한다.
2. __동시 연결 수__
    - 동시에 최대로 세션을 유지할 수 있는 개수를 의미한다.
3. __처리용량__
    - (패킷 자체에 대해 연결이 성립되는) UDP프로토콜에 대한 로드밸런싱 성능 지표이다.
    - 단위는 bps또는 pps(packet per second)를 사용한다.

---
## [대용량 세션을 위한 로드밸런서](https://d2.naver.com/helloworld/605418)
- 읽어보면 좋을 내용